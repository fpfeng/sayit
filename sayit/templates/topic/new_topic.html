{%- extends "base.html" %}
{%- from "common_macros/macro.html" import render_flash_msg %}
{%- from "common_macros/macro.html" import add_form_div with context %}
{%- from "topic/macro.html" import render_node %}
{%- if 'edit' in request.endpoint %}
    {%- set heading = '编辑主题' -%}
    {%- set post_url = url_for('topic.edit_topic', tid=tid) -%}
{%- else -%}
    {%- set heading = '新主题' -%}
    {%- set post_url = url_for('topic.new_topic') -%}
{% endif -%}
{%- block title %}{{ heading|addlt }}{{ config.SITE_NAME }}{% endblock -%}
{%- block content %}

<div class="container col-md-10 col-md-offset-1">
    <div id="node-modal" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <p class="modal-title">选择节点</p>
          </div>
          <div class="modal-body">
            {{ render_node(nodes) }}
          </div>
        </div>

      </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">{{ heading }}</div>
        <div class="panel-body">
            {{ render_flash_msg() }}
            <form role="form" method="POST" action="{{ post_url }}">
            {{ form.hidden_tag() }}
                <div class="row">
                    <div style="margin-bottom: 0;" class="form-group col-md-12 {% if form.node.errors or form.title.errors %} has-error {% endif %}">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-danger" id="select-node-btn" data-toggle="modal" data-target="#node-modal" node-id="">选择节点</button>
                            </span>
                            
                            {{ form.node(type="hidden") }}
                            {{ form.title(class='form-control', placeholder=form.title.label.text) }}
                        </div>
                        {%- if form.node.errors or form.title.errors %}
                            <p class="help-block"><span class="text-danger" style="padding-left: 10px;">{{ form.node.errors[0] }}</span><span class="text-danger" style="padding-left: 80px;">{{ form.title.errors[0] }}</span></p>
                        {%- else -%}
                            <p></p>
                        {% endif -%}
                    </div>
                </div>
                    {{ add_form_div('content', div_class=none, form_class='topic-content', cols=30, rows=20) }}
                    <button type="submit" class="btn btn-md btn-primary">提交</button>
            </form>
        </div>
    </div>
    <script>
        $(document).on('click', '.node-child', function(e) {
            e.preventDefault();
            node = this;
            parent = $(node).parent().prev().text();
            // console.log(parent);
            $('#node').attr('value', $(node).attr('value'));
            $('#select-node-btn').text(parent + " " + $(node).text());
            $('#select-node-btn').removeClass('btn-danger').addClass('btn-default');
            $('#node-modal').modal('hide');
        });

        $('#node-modal').on('shown.bs.modal', function(e){
            $('#select-node-btn').one('focus', function(e){$(this).blur();});
        });

        $(document).ready(function() {
            nid = $('#node').attr('value');
            if (nid > 10) {
                $.each($('.node-child'), function(index, node) {
                    if ($(node).attr('value') == nid) {
                        parent = $(node).parent().prev().text();
                        $('#select-node-btn').text(parent + " " + $(node).text());
                        $('#select-node-btn').removeClass('btn-danger').addClass('btn-default');
                        return false;
                    }
                });
            }
        });
    </script>
</div>
{%- endblock -%}
